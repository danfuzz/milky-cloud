#!/bin/bash
#
# Copyright 2022 Dan Bornstein.
# Licensed AS IS and WITHOUT WARRANTY under the Apache License,
# Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

# Figure out the symlink-resolved program name and directory.
progName="$(readlink -f "$0")" || exit "$?"
progDir="${progName%/*}"
progName="${progName##*/}"

. "${progDir}/init"


#
# Argument parsing
#

function usage {
    print-usage $'
    Usage:

    ${name} [<opt> ...] <resource-type> <name>

    Constructs and prints a JSON object suitable for use as a
    `TagSpecifications` argument to an AWS command, to _just_ define a
    `Name` tag. The result is an object that binds `TagSpecifications`, so
    it can be used as-is (if that is the only argument) or merged with
    other arguments.

    --output=<style> :: `compact` `json`
      Output style, as with `json-val`. Defaults to `json`.

    ${name} [--help | -h]
      Displays this message.
    '

    exit "$1"
}

# Want help?
opt-action --call=usage help/h=0

# Output style.
opt-enum --var=outputStyle --default=json output :: compact json

# Resource type.
positional-arg --required --var=resourceType --filter='/^[-a-z0-9]+$/' resource-type

# Name for the resource.
positional-arg --required --var=name --filter='/./' name

process-args "$@" || usage "$?"


#
# Main script
#

jval --output="${outputStyle}" \
    name="${name}" \
    resourceType="${resourceType}" \
    '{
        TagSpecifications: [
            {
                ResourceType: $resourceType,
                Tags: [
                    {
                        Key: "Name",
                        Value: $name
                    }
                ]
            }
        ]
    }'
