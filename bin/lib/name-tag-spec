#!/bin/bash
#
# Copyright 2022 Dan Bornstein.
# Licensed AS IS and WITHOUT WARRANTY under the Apache License,
# Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

# Figure out the symlink-resolved program name and directory.
progName="$(readlink -f "$0")" || exit "$?"
progDir="${progName%/*}"
progName="${progName##*/}"

. "${progDir}/init"


#
# Argument parsing
#

function usage {
    print-usage $'
    Usage:

    ${name} [<opt> ...] <resource-type> <name>

    Constructs and prints a JSON object suitable for use as a
    `TagSpecifications` argument to an AWS command, to _just_ define a
    `Name` tag. The result is an object that binds `TagSpecifications`, so
    it can be used as-is (if that is the only argument) or merged with
    other arguments.

    --compact
      Output in compact (not multiline) JSON form.
    --json
      Output in JSON form. This is the default.

    ${name} [--help | -h]
      Displays this message.
    '

    exit "$1"
}

# Want help?
opt-action --call=usage --value=0 help/h

# Output style.
opt-choice --var=outputStyle --default=json compact json

# Resource type.
resourceType=''

# Name for the resource.
name=''

rest-arg --call=parse-rest
function parse-rest {
    if (( $# < 2 )); then
        echo 1>&2 'Missing argument: resource type and/or name'
        return 1
    elif (( $# > 2 )); then
        echo 1>&2 'Too many arguments.'
        return 1
    fi

    resourceType="$1"
    name="$2"
}

process-args "$@" || usage "$?"


#
# Main script
#

jval --"${outputStyle}" \
    name="${name}" \
    resourceType="${resourceType}" \
    '{
        TagSpecifications: [
            {
                ResourceType: $resourceType,
                Tags: [
                    {
                        Key: "Name",
                        Value: $name
                    }
                ]
            }
        ]
    }'
