#!/bin/bash
#
# Copyright 2022 Dan Bornstein.
# Licensed AS IS and WITHOUT WARRANTY under the Apache License,
# Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

# Figure out the symlink-resolved program name and directory.
progName="$(readlink -f "$0")" || exit "$?"
progDir="${progName%/*}"
progName="${progName##*/}"

. "${progDir}/init"


#
# Argument parsing
#

function usage {
    print-usage $'
    Usage:

    ${name} [<opt> ...] <zone-or-region>
      Parses a location -- a region or availability zone -- and if
      valid then optionally prints out one of the components.

      --input=<style>
        `any` -- Accept either an availability zone or region as <zone-or-region>.
        `region` -- Require a region.
        `zone` -- Require an availability zone.
      --print-none
        Do not print anything. This is the default.
      --print-region
        Print the parsed region.
      --print-zone
        Print the full zone (which will be the same as the input). Implies
        `--input-zone`.
      --print-zone-suffix
        Print the zone suffix (everything after the region). This implies
        `--input=zone`.

    ${name} [--help | -h]
      Displays this message.
    '

    exit "$1"
}

# Want help?
opt-action --call=usage help/h=0

# Input type.
opt-enum --var=inputType --default=any input :: any region zone

# Item to print.
opt-choice --var=printItem --default=print-none \
    print-none print-region print-zone print-zone-suffix

# Location to parse, and parsed bits.
region=''
zoneSuffix=''
positional-arg --required --var=zoneOrRegion --call=parse-zone-or-region zone-or-region
function parse-zone-or-region {
    if [[ ! $1 =~ ^([a-z]{2}-[a-z]+-[0-9]+)([a-z]|-[a-z]+-[0-9]+[a-z])?$ ]]; then
        echo 1>&2 'Invalid value for argument <zone-or-region>:' "$1"
        exit 1
    fi

    region="${BASH_REMATCH[1]}"
    zoneSuffix="${BASH_REMATCH[2]}"
}

process-args "$@" || usage "$?"

if [[ ${printItem} =~ ^print-zone ]]; then
    # Don't allow region input if we are to print a zone-ish thing.
    inputType='zone'
fi


#
# Main script
#

# Validate the required input type, if needed.
case "${inputType}" in
    region)
        if [[ ${zoneSuffix} != '' ]]; then
            echo 1>&2 "Region required; got zone: ${zoneOrRegion}"
            exit 1
        fi
        ;;
    zone)
        if [[ ${zoneSuffix} == '' ]]; then
            echo 1>&2 "Zone required; got region: ${zoneOrRegion}"
            exit 1
        fi
        ;;
esac

# Output whatever is requested, if anything.
case "${printItem}" in
    print-region)
        echo "${region}"
        ;;
    print-zone)
        echo "${zoneOrRegion}"
        ;;
    print-zone-suffix)
        echo "${zoneSuffix}"
        ;;
esac
