#!/bin/bash
#
# Copyright 2022 Dan Bornstein.
# Licensed AS IS and WITHOUT WARRANTY under the Apache License,
# Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

# Figure out the symlink-resolved program name and directory.
progName="$(readlink -f "$0")" || exit "$?"
progDir="${progName%/*}"
progName="${progName##*/}"

# Load the helper library.
. "${progDir}/lib/init"


#
# Argument parsing
#

function usage {
    print-usage $'
    Usage:

    ${name} [<opt> ...]
      Lists all accessible availability zones in a given region.

      --loc=<region-or-zone>
        What region to look in. Must be specified. If specified as an
        availability zone, only the region portion matters.
      --output=<style> :: `compact` `json` `lines`
        Output style, as with `json-val`. Defaults to `lines`.

    ${name} [--help | -h]
      Displays this message.
    '

    exit "$1"
}

# Want help?
opt-action --call=usage help/h=0

# Region, passed as either region per se or availability zone.
opt-value --required --var=region --filter=region-from-location loc

# Output style.
opt-enum --var=outputStyle --default=lines output :: compact json lines

process-args "$@" || usage "$?"


#
# Main script
#

cmd=(ec2-json describe-availability-zones
    --loc="${region}"
    :: --output="${outputStyle}" '.AvailabilityZones | map(.ZoneName) | sort')

if [[ "${outputStyle}" == 'lines' ]]; then
    cmd+=('| .[]')
fi

"${cmd[@]}"
